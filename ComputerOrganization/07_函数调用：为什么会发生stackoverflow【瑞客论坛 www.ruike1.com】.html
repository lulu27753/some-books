<html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"> <meta name="format-detection" content="telephone=no"> <title>07 | 函数调用：为什么会发生stack overflow？</title>         <style type="text/css"> html { color: #333; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; text-rendering: optimizelegibility; font-family: Helvetica Neue,PingFang SC,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif } html.borderbox *,html.borderbox :after,html.borderbox :before { box-sizing: border-box } article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul { margin: 0; padding: 0 } article,aside,details,figcaption,figure,footer,header,menu,nav,section { display: block } audio,canvas,video { display: inline-block } body,button,input,select,textarea { font: 300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif } button::-moz-focus-inner,input::-moz-focus-inner { padding: 0; border: 0 } table { border-collapse: collapse; border-spacing: 0 } fieldset,img { border: 0 } blockquote { position: relative; color: #999; font-weight: 400; border-left: 1px solid #1abc9c; padding-left: 1em; margin: 1em 3em 1em 2em } @media only screen and (max-width: 640px) { blockquote { margin:1em 0 } } abbr,acronym { border-bottom: 1px dotted; font-variant: normal } abbr { cursor: help } del { text-decoration: line-through } address,caption,cite,code,dfn,em,th,var { font-style: normal; font-weight: 400 } ol,ul { list-style: none } caption,th { text-align: left } q:after,q:before { content: "" } sub,sup { font-size: 75%; line-height: 0; position: relative } :root sub,:root sup { vertical-align: baseline } sup { top: -.5em } sub { bottom: -.25em } a { color: #1abc9c } a:hover { text-decoration: underline } .typo a { border-bottom: 1px solid #1abc9c } .typo a:hover { border-bottom-color: #555; color: #555 } .typo a:hover,a,ins { text-decoration: none } .typo-u,u { text-decoration: underline } mark { background: #fffdd1; border-bottom: 1px solid #ffedce; padding: 2px; margin: 0 5px } code,pre,pre tt { font-family: Courier,Courier New,monospace } pre { background: hsla(0,0%,97%,.7); border: 1px solid #ddd; padding: 1em 1.5em; display: block; -webkit-overflow-scrolling: touch } hr { border: none; border-bottom: 1px solid #cfcfcf; margin-bottom: .8em; height: 10px } .typo-small,figcaption,small { font-size: .9em; color: #888 } b,strong { font-weight: 700; color: #000 } [draggable] { cursor: move } .clearfix:after,.clearfix:before { content: ""; display: table } .clearfix:after { clear: both } .clearfix { zoom:1} .textwrap,.textwrap td,.textwrap th { word-wrap: break-word; word-break: break-all } .textwrap-table { table-layout: fixed } .serif { font-family: Palatino,Optima,Georgia,serif } .typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote { margin-bottom: 1rem } h1,h2,h3,h4,h5,h6 { font-family: PingFang SC,Helvetica Neue,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif; color: #000; line-height: 1.35 } .typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6 { margin-top: 1.2em; margin-bottom: .6em; line-height: 1.35 } .typo-h1,.typo h1 { font-size: 2em } .typo-h2,.typo h2 { font-size: 1.8em } .typo-h3,.typo h3 { font-size: 1.6em } .typo-h4,.typo h4 { font-size: 1.4em } .typo-h5,.typo-h6,.typo h5,.typo h6 { font-size: 1.2em } .typo-ul,.typo ul { margin-left: 1.3em; list-style: disc } .typo-ol,.typo ol { list-style: decimal; margin-left: 1.9em } .typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul { margin-bottom: .8em; margin-left: 2em } .typo-ol ul,.typo-ul ul,.typo li ul { list-style: circle } .typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th { border: 1px solid #ddd; padding: .5em 1em; color: #666 } .typo-table th,.typo table th { background: #fbfbfb } .typo-table thead th,.typo table thead th { background: hsla(0,0%,95%,.7) } .typo table caption { border-bottom: none } .typo-input,.typo-textarea { -webkit-appearance: none; border-radius: 0 } .typo-em,.typo em,caption,legend { color: #000; font-weight: inherit } .typo-em { position: relative } .typo-em:after { position: absolute; top: .65em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB" } .typo img { max-width: 100% } .common-content { font-weight: 400; color: #353535; line-height: 1.75rem; white-space: normal; word-break: normal; font-size: 1rem } .common-content img { display: block; max-width: 100%; background-color: #eee } .common-content audio,.common-content video { width: 100%; background-color: #eee } .common-content center,.common-content font { margin-top: 1rem; display: inline-block } .common-content center { width: 100% } .common-content pre { margin-top: 1rem; padding-left: 0; padding-right: 0; position: relative; overflow: hidden } .common-content pre code { font-size: .8rem; font-family: Consolas,Liberation Mono,Menlo,monospace,Courier; display: block; width: 100%; box-sizing: border-box; padding-left: 1rem; padding-right: 1rem; overflow-x: auto } .common-content hr { border: none; margin-top: 1.5rem; margin-bottom: 1.5rem; border-top: 1px solid #f5f5f5; height: 1px; background: none } .common-content b,.common-content h1,.common-content h2,.common-content h3,.common-content h4,.common-content h5,.common-content strong { font-weight: 700 } .common-content h1,.common-content h2 { font-size: 1.125rem; margin-bottom: .45rem } .common-content h3,.common-content h4,.common-content h5 { font-size: 1rem; margin-bottom: .45rem } .common-content p { font-weight: 400; color: #353535; margin-top: .15rem } .common-content .orange { color: #ff5a05 } .common-content .reference { font-size: 1rem; color: #888 } .custom-rich-content h1 { margin-top: 0; font-weight: 400; font-size: 15.25px; border-bottom: 1px solid #eee; line-height: 2.8 } .custom-rich-content li,.custom-rich-content p { font-size: 14px; color: #888; line-height: 1.6 } table.hljs-ln { margin-bottom: 0; border-spacing: 0; border-collapse: collapse } table.hljs-ln,table.hljs-ln tbody,table.hljs-ln td,table.hljs-ln tr { box-sizing: border-box } table.hljs-ln td { padding: 0; border: 0 } table.hljs-ln td.hljs-ln-numbers { min-width: 15px; color: rgba(27,31,35,.3); text-align: right; white-space: nowrap; cursor: pointer; user-select: none } table.hljs-ln td.hljs-ln-code,table.hljs-ln td.hljs-ln-numbers { font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace; font-size: 12px; line-height: 20px; vertical-align: top } table.hljs-ln td.hljs-ln-code { position: relative; padding-right: 10px; padding-left: 10px; overflow: visible; color: #24292e; word-wrap: normal; white-space: pre } video::-webkit-media-controls { overflow: hidden!important } video::-webkit-media-controls-enclosure { width: calc(100% + 32px); margin-left: auto } .button-cancel { color: #888; border: 1px solid #888; border-radius: 3px; margin-right: 12px } .button-cancel,.button-primary { -ms-flex-positive: 1; flex-grow: 1; height: 35px; display: inline-block; font-size: 15px; text-align: center; line-height: 36px } .button-primary { color: #fff; background-color: #ff5a05; border-radius: 3px } @font-face { font-family: iconfont; src: url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot); src: url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.woff) format("woff"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.ttf) format("truetype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.svg#iconfont) format("svg") } @font-face { font-family: player-font; src: url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot); src: url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.woff) format("woff"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.ttf) format("truetype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.svg#player-font) format("svg") } .iconfont { font-family: iconfont!important; font-size: 16px; font-style: normal; -webkit-font-smoothing: antialiased; -webkit-text-stroke-width: .2px; -moz-osx-font-smoothing: grayscale } html { background: #fff; min-height: 100%; -webkit-tap-highlight-color: rgba(0,0,0,0) } body { width: 100% } body.fixed { overflow: hidden; position: fixed; width: 100vw; height: 100vh } i { font-style: normal } a { word-wrap: break-word; -webkit-tap-highlight-color: rgba(0,0,0,0) } a:hover { text-decoration: none } .fade-enter-active,.fade-leave-active { transition: opacity .3s } .fade-enter,.fade-leave-to { opacity: 0 } .MathJax,.MathJax_CHTML,.MathJax_MathContainer,.MathJax_MathML,.MathJax_PHTML,.MathJax_PlainSource,.MathJax_SVG { outline: 0 } .ios-app-switch .js-audit { display: none } ._loading_wrap_ { position: fixed; width: 100vw; height: 100vh; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 999 } ._loading_div_class_,._loading_wrap_ { display: -ms-flexbox; display: flex; -ms-flex-pack: center; justify-content: center; -ms-flex-align: center; align-items: center } ._loading_div_class_ { word-wrap: break-word; padding: .5rem .75rem; text-align: center; z-index: 9999; font-size: .6rem; max-width: 60%; color: #fff; border-radius: .25rem; -ms-flex-direction: column; flex-direction: column } ._loading_div_class_ .message { color: #353535; font-size: 16px; line-height: 3 } .spinner { animation: circle-rotator 1.4s linear infinite } .spinner * { line-height: 0; box-sizing: border-box } @keyframes circle-rotator { 0% { transform: rotate(0deg) } to { transform: rotate(270deg) } } .path { stroke-dasharray: 187; stroke-dashoffset: 0; transform-origin: center; animation: circle-dash 1.4s ease-in-out infinite,circle-colors 5.6s ease-in-out infinite } @keyframes circle-colors { 0% { stroke: #ff5a05 } to { stroke: #ff5a05 } } @keyframes circle-dash { 0% { stroke-dashoffset: 187 } 50% { stroke-dashoffset: 46.75; transform: rotate(135deg) } to { stroke-dashoffset: 187; transform: rotate(450deg) } } .confirm-box-wrapper,.confirm-box-wrapper .mask { position: absolute; top: 0; left: 0; right: 0; bottom: 0 } .confirm-box-wrapper .mask { background: rgba(0,0,0,.6) } .confirm-box-wrapper .confirm-box { position: fixed; top: 50%; left: 50%; width: 267px; background: #fff; transform: translate(-50%,-50%); border-radius: 7px } .confirm-box-wrapper .confirm-box .head { margin: 0 18px; font-size: 18px; text-align: center; line-height: 65px; border-bottom: 1px solid #d9d9d9 } .confirm-box-wrapper .confirm-box .body { padding: 18px; padding-bottom: 0; color: #353535; font-size: 12.5px; max-height: 150px; overflow: auto } .confirm-box-wrapper .confirm-box .foot { display: -ms-flexbox; display: flex; -ms-flex-direction: row; flex-direction: row; padding: 18px } .confirm-box-wrapper .confirm-box .foot .button-cancel { border: 1px solid #d9d9d9 } .hljs { display: block; overflow-x: auto; padding: .5em; color: #333; background: #f8f8f8 } .hljs-comment,.hljs-quote { color: #998; font-style: italic } .hljs-keyword,.hljs-selector-tag,.hljs-subst { color: #333; font-weight: 700 } .hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable { color: teal } .hljs-doctag,.hljs-string { color: #d14 } .hljs-section,.hljs-selector-id,.hljs-title { color: #900; font-weight: 700 } .hljs-subst { font-weight: 400 } .hljs-class .hljs-title,.hljs-type { color: #458; font-weight: 700 } .hljs-attribute,.hljs-name,.hljs-tag { color: navy; font-weight: 400 } .hljs-link,.hljs-regexp { color: #009926 } .hljs-bullet,.hljs-symbol { color: #990073 } .hljs-built_in,.hljs-builtin-name { color: #0086b3 } .hljs-meta { color: #999; font-weight: 700 } .hljs-deletion { background: #fdd } .hljs-addition { background: #dfd } .hljs-emphasis { font-style: italic } .hljs-strong { font-weight: 700 } .button-cancel[data-v-87ffcada] { color: #888; border: 1px solid #888; border-radius: 3px; margin-right: 12px } .button-cancel[data-v-87ffcada],.button-primary[data-v-87ffcada] { -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1; height: 35px; display: inline-block; font-size: 15px; text-align: center; line-height: 36px } .button-primary[data-v-87ffcada] { color: #fff; background-color: #ff5a05; border-radius: 3px } .pd[data-v-87ffcada] { padding-left: 1.375rem; padding-right: 1.375rem } .article[data-v-87ffcada] { max-width: 70rem; margin: 0 auto } .article .article-unavailable[data-v-87ffcada] { color: #fa8919; font-size: 15px; font-weight: 600; line-height: 24px; border-radius: 5px; padding: 12px; background-color: #f6f7fb; margin-top: 20px } .article .article-unavailable .iconfont[data-v-87ffcada] { font-size: 12px } .article .main[data-v-87ffcada] { padding: 1.25rem 0; margin-bottom: 52px } .article-title[data-v-87ffcada] { color: #353535; font-weight: bold; line-height: 1.65rem; font-size: 1.34375rem } .article-info[data-v-87ffcada] { color: #888; font-size: .9375rem; margin-top: 1.0625rem } .article-content[data-v-87ffcada] { margin-top: 1.0625rem } .article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button { display: none } .copyright[data-v-87ffcada] { color: #b2b2b2; padding-bottom: 20px; margin-top: 20px; font-size: 13px } .audio-player[data-v-87ffcada] { width: 100%; margin: 20px 0 } .to-comment[data-v-87ffcada] { overflow: hidden; padding-top: 10px; margin-bottom: -30px } .to-comment a.button-primary[data-v-87ffcada] { float: right; height: 20px; font-size: 12px; line-height: 20px; padding: 4px 8px; cursor: pointer } .article-comments[data-v-87ffcada] { margin-top: 2rem } .article-comments h2[data-v-87ffcada] { text-align: center; color: #888; position: relative; z-index: 1; margin-bottom: 1rem } .article-comments h2[data-v-87ffcada]:before { border-top: 1px dotted #888; content: ""; position: absolute; top: 56%; left: 0; width: 100%; z-index: -1 } .article-comments h2 span[data-v-87ffcada] { font-size: 15.25px; font-weight: 400; padding: 0 1rem; background: #fff; display: inline-block } .article-sub-bottom[data-v-87ffcada] { z-index: 10; cursor: pointer } .switch-btns[data-v-87ffcada] { height: 76px; cursor: pointer; padding-top: 24px; padding-bottom: 24px; border-bottom: 10px solid #f6f7fb; position: relative } .switch-btns[data-v-87ffcada]:before { content: " "; height: 1px; background: #e8e8e8; position: absolute; top: 0; left: 0; -webkit-box-sizing: border-box; box-sizing: border-box; left: 1.375rem; right: 1.375rem } .switch-btns .btn[data-v-87ffcada] { height: 38px; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .switch-btns .btn .tag[data-v-87ffcada] { -webkit-box-flex: 0; -ms-flex: 0 0 62px; flex: 0 0 62px; text-align: center; color: #888; font-size: 14px; border-radius: 10px; height: 22px; line-height: 22px; background: #f6f7fb; font-weight: 400 } .switch-btns .btn .txt[data-v-87ffcada] { margin-left: 10px; -webkit-box-flex: 1; -ms-flex: 1 1 auto; flex: 1 1 auto; color: #888; font-size: 15px; height: 22px; line-height: 22px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 400 } @media (max-width: 769px) { .article .breadcrumb[data-v-87ffcada] { padding-top:10px; padding-bottom: 10px } } .comment-item { list-style-position: inside; width: 100%; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; margin-bottom: 1rem } .comment-item a { border-bottom: none } .comment-item .avatar { width: 2.625rem; height: 2.625rem; -ms-flex-negative: 0; flex-shrink: 0; border-radius: 50% } .comment-item .info { margin-left: .5rem; -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1 } .comment-item .info .hd { width: 100%; display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-pack: justify; -ms-flex-pack: justify; justify-content: space-between; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .comment-item .info .hd .username { color: #888; font-size: 15.25px; font-weight: 400; line-height: 1.2 } .comment-item .info .hd .control { display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-align: center; -ms-flex-align: center; align-items: center } .comment-item .info .hd .control .btn-share { color: #888; font-size: .75rem; margin-right: 1rem } .comment-item .info .hd .control .btn-praise { display: -webkit-box; display: -ms-flexbox; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; -ms-flex-direction: row; flex-direction: row; -webkit-box-align: center; -ms-flex-align: center; align-items: center; font-size: 15.25px; text-decoration: none } .comment-item .info .hd .control .btn-praise i { color: #888; display: inline-block; font-size: .75rem; margin-right: .3rem; margin-top: -.01rem } .comment-item .info .hd .control .btn-praise i.on,.comment-item .info .hd .control .btn-praise span { color: #ff5a05 } .comment-item .info .bd { color: #353535; font-size: 15.25px; font-weight: 400; white-space: normal; word-break: break-all; line-height: 1.6 } .comment-item .info .time { color: #888; font-size: 9px; line-height: 1 } .comment-item .info .reply .reply-hd { font-size: 15.25px } .comment-item .info .reply .reply-hd span { margin-left: -12px; color: #888; font-weight: 400 } .comment-item .info .reply .reply-hd i { color: #ff5a05; font-size: 15.25px } .comment-item .info .reply .reply-content { background: #f6f7fb; padding: 18px; border-radius: 10px; color: #353535; font-size: 15.25px; font-weight: 400; white-space: normal; word-break: break-all } .comment-item .info .reply .reply-time { color: #888; font-size: 9px } </style> </head> <body> <div id="app"> <div data-v-87ffcada="" class="article" id="watermark"> <div data-v-87ffcada="" class="main main-app"> <h1 data-v-87ffcada="" class="article-title pd"> 07 | 函数调用：为什么会发生stack overflow？ </h1> <hr> <div data-v-87ffcada="" class="article-content typo common-content pd"> <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/5e/2c/5e068ce407b89cbc379b7e5fde2b7f2c.jpg"> <div data-v-87ffcada="" id="article-content" class=""> <div class="text"> <p>在开发软件的过程中我们经常会遇到错误，如果你用Google搜过出错信息，那你多少应该都访问过<a href="https://stackoverflow.com/">Stack Overflow</a>这个网站。作为全球最大的程序员问答网站，Stack Overflow的名字来自于一个常见的报错，就是栈溢出（stack overflow）。</p><p>今天，我们就从程序的函数调用开始，讲讲函数间的相互调用，在计算机指令层面是怎么实现的，以及什么情况下会发生栈溢出这个错误。</p><h2>为什么我们需要程序栈？</h2><p>和前面几讲一样，我们还是从一个非常简单的C程序function_example.c看起。</p><pre><code>// function_example.c
#include &lt;stdio.h&gt;
int static add(int a, int b)
{
    return a+b;
}


int main()
{
    int x = 5;
    int y = 10;
    int u = add(x, y);
}
</code></pre><p>这个程序定义了一个简单的函数add，接受两个参数a和b，返回值就是a+b。而main函数里则定义了两个变量x和y，然后通过调用这个add函数，来计算u=x+y，最后把u的数值打印出来。</p><pre><code>$ gcc -g -c function_example.c
$ objdump -d -M intel -S function_example.o
</code></pre><p>我们把这个程序编译之后，objdump出来。我们来看一看对应的汇编代码。</p><pre><code>int static add(int a, int b)
{
   0:   55                      push   rbp
   1:   48 89 e5                mov    rbp,rsp
   4:   89 7d fc                mov    DWORD PTR [rbp-0x4],edi
   7:   89 75 f8                mov    DWORD PTR [rbp-0x8],esi
    return a+b;
   a:   8b 55 fc                mov    edx,DWORD PTR [rbp-0x4]
   d:   8b 45 f8                mov    eax,DWORD PTR [rbp-0x8]
  10:   01 d0                   add    eax,edx
}
  12:   5d                      pop    rbp
  13:   c3                      ret    
0000000000000014 &lt;main&gt;:
int main()
{
  14:   55                      push   rbp
  15:   48 89 e5                mov    rbp,rsp
  18:   48 83 ec 10             sub    rsp,0x10
    int x = 5;
  1c:   c7 45 fc 05 00 00 00    mov    DWORD PTR [rbp-0x4],0x5
    int y = 10;
  23:   c7 45 f8 0a 00 00 00    mov    DWORD PTR [rbp-0x8],0xa
    int u = add(x, y);
  2a:   8b 55 f8                mov    edx,DWORD PTR [rbp-0x8]
  2d:   8b 45 fc                mov    eax,DWORD PTR [rbp-0x4]
  30:   89 d6                   mov    esi,edx
  32:   89 c7                   mov    edi,eax
  34:   e8 c7 ff ff ff          call   0 &lt;add&gt;
  39:   89 45 f4                mov    DWORD PTR [rbp-0xc],eax
  3c:   b8 00 00 00 00          mov    eax,0x0
}
  41:   c9                      leave  
  42:   c3                      ret    
</code></pre><p>可以看出来，在这段代码里，main函数和上一节我们讲的的程序执行区别并不大，它主要是把jump指令换成了函数调用的call指令。call指令后面跟着的，仍然是跳转后的程序地址。</p><p>这些你理解起来应该不成问题。我们下面来看一个有意思的部分。</p><!-- [[[read_end]]] --><p>我们来看add函数。可以看到，add函数编译之后，代码先执行了一条push指令和一条mov指令；在函数执行结束的时候，又执行了一条pop和一条ret指令。这四条指令的执行，其实就是在进行我们接下来要讲<strong>压栈</strong>（Push）和<strong>出栈</strong>（Pop）操作。</p><p>你有没有发现，函数调用和上一节我们讲的if…else和for/while循环有点像。它们两个都是在原来顺序执行的指令过程里，执行了一个内存地址的跳转指令，让指令从原来顺序执行的过程里跳开，从新的跳转后的位置开始执行。</p><p>但是，这两个跳转有个区别，if…else和for/while的跳转，是跳转走了就不再回来了，就在跳转后的新地址开始顺序地执行指令，就好像徐志摩在《再别康桥》里面写的：“我挥一挥衣袖，不带走一片云彩”，继续进行新的生活了。而函数调用的跳转，在对应函数的指令执行完了之后，还要再回到函数调用的地方，继续执行call之后的指令，就好像贺知章在《回乡偶书》里面写的那样：“少小离家老大回，乡音未改鬓毛衰”，不管走多远，最终还是要回来。</p><p>那我们有没有一个可以不跳转回到原来开始的地方，来实现函数的调用呢？直觉上似乎有这么一个解决办法。你可以把调用的函数指令，直接插入在调用函数的地方，替换掉对应的call指令，然后在编译器编译代码的时候，直接就把函数调用变成对应的指令替换掉。</p><p>不过，仔细琢磨一下，你会发现这个方法有些问题。如果函数A调用了函数B，然后函数B再调用函数A，我们就得面临在A里面插入B的指令，然后在B里面插入A的指令，这样就会产生无穷无尽地替换。就好像两面镜子面对面放在一块儿，任何一面镜子里面都会看到无穷多面镜子。</p><p><img src="https://static001.geekbang.org/resource/image/0b/06/0b4d9f07a7d15e5e25908bbf1532e706.jpg" alt=""></p><center>Infinite Mirror Effect，如果函数A调用B，B再调用A，那么代码会无限展开，<a href="https://commons.wikimedia.org/w/index.php?curid=40716759">图片来源</a></center><p>看来，把被调用函数的指令直接插入在调用处的方法行不通。那我们就换一个思路，能不能把后面要跳回来执行的指令地址给记录下来呢？就像前面讲PC寄存器一样，我们可以专门设立一个“程序调用寄存器”，来存储接下来要跳转回来执行的指令地址。等到函数调用结束，从这个寄存器里取出地址，再跳转到这个记录的地址，继续执行就好了。</p><p>但是在多层函数调用里，简单只记录一个地址也是不够的。我们在调用函数A之后，A还可以调用函数B，B还能调用函数C。这一层又一层的调用并没有数量上的限制。在所有函数调用返回之前，每一次调用的返回地址都要记录下来，但是我们CPU里的寄存器数量并不多。像我们一般使用的Intel i7 CPU只有16个64位寄存器，调用的层数一多就存不下了。</p><p>最终，计算机科学家们想到了一个比单独记录跳转回来的地址更完善的办法。我们在内存里面开辟一段空间，用栈这个<strong>后进先出</strong>（LIFO，Last In First Out）的数据结构。栈就像一个乒乓球桶，每次程序调用函数之前，我们都把调用返回后的地址写在一个乒乓球上，然后塞进这个球桶。这个操作其实就是我们常说的<strong>压栈</strong>。如果函数执行完了，我们就从球桶里取出最上面的那个乒乓球，很显然，这就是<strong>出栈</strong>。</p><p>拿到出栈的乒乓球，找到上面的地址，把程序跳转过去，就返回到了函数调用后的下一条指令了。如果函数A在执行完成之前又调用了函数B，那么在取出乒乓球之前，我们需要往球桶里塞一个乒乓球。而我们从球桶最上面拿乒乓球的时候，拿的也一定是最近一次的，也就是最下面一层的函数调用完成后的地址。乒乓球桶的底部，就是<strong>栈底</strong>，最上面的乒乓球所在的位置，就是<strong>栈顶</strong>。</p><p><img src="https://static001.geekbang.org/resource/image/d0/be/d0c75219d3a528c920c2a593daaf77be.jpeg" alt=""></p><p>在真实的程序里，压栈的不只有函数调用完成后的返回地址。比如函数A在调用B的时候，需要传输一些参数数据，这些参数数据在寄存器不够用的时候也会被压入栈中。整个函数A所占用的所有内存空间，就是函数A的<strong>栈帧</strong>（Stack Frame）。Frame在中文里也有“相框”的意思，所以，每次到这里，我都有种感觉，整个函数A所需要的内存空间就像是被这么一个“相框”给框了起来，放在了栈里面。</p><p>而实际的程序栈布局，顶和底与我们的乒乓球桶相比是倒过来的。底在最上面，顶在最下面，这样的布局是因为栈底的内存地址是在一开始就固定的。而一层层压栈之后，栈顶的内存地址是在逐渐变小而不是变大。</p><p><img src="https://static001.geekbang.org/resource/image/23/d1/2361ecf8cf08f07c83377376a31869d1.jpeg" alt=""></p><p>对应上面函数add的汇编代码，我们来仔细看看，main函数调用add函数时，add函数入口在0～1行，add函数结束之后在12～13行。</p><p>add函数的第0行，push rbp这个指令，就是在进行压栈。这里的rbp又叫栈帧指针（Frame Pointer），是一个存放了当前栈帧位置的寄存器。push rbp就把之前调用函数的返回地址，压到栈顶。接着，第1行的一条命令mov rbp, rsp里，则是把rsp这个栈指针（Stack Pointer）的值复制到rbp里，而rsp始终会指向栈顶。这个命令意味着，rbp这个栈帧指针指向的返回地址，变成当前最新的栈顶，也就是add函数的返回地址了。</p><p>而在函数add执行完成之后，又会分别调用第12行的pop rbp来将当前的栈顶出栈，然后调用第13行的ret指令，将程序的控制权返回到出栈后的栈顶，也就是main函数的返回地址。</p><h2>如何构造一个stack  overflow？</h2><p>通过引入栈，我们可以看到，无论有多少层的函数调用，或者在函数A里调用函数B，再在函数B里调用A，这样的递归调用，我们都只需要通过维持rbp和rsp，这两个维护栈顶所在地址的寄存器，就能管理好不同函数之间的跳转。不过，栈的大小也是有限的。如果函数调用层数太多，我们往栈里压入它存不下的内容，程序在执行的过程中就会遇到栈溢出的错误，这就是大名鼎鼎的“stack  overflow”。</p><p>要构造一个栈溢出的错误并不困难，最简单的办法，就是我们上面说的Infiinite Mirror Effect的方式，让函数A调用自己，并且不设任何终止条件。这样一个无限递归的程序，在不断地压栈过程中，将整个栈空间填满，并最终遇上stack  overflow。</p><pre><code>int a()
{
  return a();
}


int main()
{
  a();
  return 0;
}
</code></pre><p>除了无限递归，递归层数过深，在栈空间里面创建非常占内存的变量（比如一个巨大的数组），这些情况都很可能给你带来stack  overflow。相信你理解了栈在程序运行的过程里面是怎么回事，未来在遇到stackoverflow这个错误的时候，不会完全没有方向了。</p><h2>如何利用函数内联进行性能优化？</h2><p>上面我们提到一个方法，把一个实际调用的函数产生的指令，直接插入到的位置，来替换对应的函数调用指令。尽管这个通用的函数调用方案，被我们否决了，但是如果被调用的函数里，没有调用其他函数，这个方法还是可以行得通的。</p><p>事实上，这就是一个常见的编译器进行自动优化的场景，我们通常叫<strong>函数内联</strong>（Inline）。我们只要在GCC编译的时候，加上对应的一个让编译器自动优化的参数-O，编译器就会在可行的情况下，进行这样的指令替换。</p><p>我们来看一段代码。</p><pre><code>#include &lt;stdio.h&gt;
#include &lt;time.h&gt;
#include &lt;stdlib.h&gt;

int static add(int a, int b)
{
    return a+b;
}

int main()
{
    srand(time(NULL));
    int x = rand() % 5
    int y = rand() % 10;
    int u = add(x, y)
    printf(&quot;u = %d\n&quot;, u)
}
</code></pre><p>为了避免编译器优化掉太多代码，我小小修改了一下function_example.c，让参数x和y都变成了，通过随机数生成，并在代码的最后加上将u通过printf打印出来的语句。</p><pre><code>$ gcc -g -c -O function_example_inline.c
$ objdump -d -M intel -S function_example_inline.o
</code></pre><p>上面的function_example_inline.c的编译出来的汇编代码，没有把add函数单独编译成一段指令顺序，而是在调用u = add(x, y)的时候，直接替换成了一个add指令。</p><pre><code>    return a+b;
  4c:   01 de                   add    esi,ebx
</code></pre><p>除了依靠编译器的自动优化，你还可以在定义函数的地方，加上inline的关键字，来提示编译器对函数进行内联。</p><p>内联带来的优化是，CPU需要执行的指令数变少了，根据地址跳转的过程不需要了，压栈和出栈的过程也不用了。</p><p>不过内联并不是没有代价，内联意味着，我们把可以复用的程序指令在调用它的地方完全展开了。如果一个函数在很多地方都被调用了，那么就会展开很多次，整个程序占用的空间就会变大了。</p><p><img src="https://static001.geekbang.org/resource/image/dc/85/dca83475560147d4dd492ff283ae0c85.jpeg" alt=""></p><p>这样没有调用其他函数，只会被调用的函数，我们一般称之为<strong>叶子函数（或叶子过程）</strong>。</p><h2>总结延伸</h2><p>这一节，我们讲了一个程序的函数间调用，在CPU指令层面是怎么执行的。其中一定需要你牢记的，就是<strong>程序栈</strong>这个新概念。</p><p>我们可以方便地通过压栈和出栈操作，使得程序在不同的函数调用过程中进行转移。而函数内联和栈溢出，一个是我们常常可以选择的优化方案，另一个则是我们会常遇到的程序Bug。</p><p>通过加入了程序栈，我们相当于在指令跳转的过程种，加入了一个“记忆”的功能，能在跳转去运行新的指令之后，再回到跳出去的位置，能够实现更加丰富和灵活的指令执行流程。这个也为我们在程序开发的过程中，提供了“函数”这样一个抽象，使得我们在软件开发的过程中，可以复用代码和指令，而不是只能简单粗暴地复制、粘贴代码和指令。</p><h2>推荐阅读</h2><p>如果你觉得还不过瘾，可以仔细读一下《深入理解计算机系统（第三版）》的3.7小节《过程》，进一步了解函数调用是怎么回事。</p><p>另外，我推荐你花一点时间，通过搜索引擎搞清楚function_example.c每一行汇编代码的含义，这个能够帮你进一步深入了解程序栈、栈帧、寄存器以及Intel CPU的指令集。</p><h2>课后思考</h2><p>在程序栈里面，除了我们跳转前的指令地址外，还需要保留哪些信息，才能在我们在函数调用完成之后，跳转回到指令地址的时候，继续执行完函数调用之后的指令呢？</p><p>你可以想一想，查一查，然后在留言区留下你的思考和答案，也欢迎你把今天的内容分享给你的朋友，和他一起思考和进步。</p><p><img src="https://static001.geekbang.org/resource/image/28/29/281ca28b90c8aa0aecbb5adc08394f29.jpg" alt=""></p> </div> </div> <div data-v-87ffcada="" class="article-comments"><h2 data-v-87ffcada=""><span data-v-87ffcada="">精选留言</span></h2> <ul data-v-87ffcada="">  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/ed/f8/b6aad044.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">CGer_AJ</span> </div> <div class="bd">这个很好 讲的很细 这两章我要反复看 并手动实践 感觉作者 把这个课讲的生动形象~这个绝对是最值的课程<br></div> <span class="time">2019-05-09</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/50/4a/04fef27f.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">kdb_reboot</span> </div> <div class="bd">倒数第二图比较好 <br>补充一下寄存器说明<br>rbp - register base pointer (start of stack)<br>rsp - register stack pointer (current location in stack, growing downwards)<br>建议将图编号这样评论的时候也能有所指代<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">kdb_reboot，谢谢建议。这个建议不错，我麻烦编辑稍后加上。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Spring</span> </div> <div class="bd">call之后，原函数的bp就会赋值为sp，因此只要把bp压栈就好了，call之后再把之前压栈的bp出栈赋值给sp就好了。<br>函数返回后会把返回值放到ax寄存器，如果有多个返回值的话就将返回值的内存地址放到ax中。<br>因此call之后恢复回原函数还要保存bp和返回值。<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">还需要考虑函数的调用参数传递哦。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">曾轼麟</span> </div> <div class="bd">看了前面这几篇文章，感觉专栏有点倾向操作系统原理更多一些<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">组成是一门牵涉到操作系统、编译、数字电路等很多核心课程的内容。程序加载和链接部分的确和操作系统和编译原理脱不开关系，但是想要深入理解操作系统，还是要专门上一门操作系统的课。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/4d/79/7b6eb74f.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">zlw</span> </div> <div class="bd">ret接着出栈后的栈顶继续执行，是rbp还是rsp?rsp始终指向栈顶怎么做到的?<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">其实是在call的时候会对PC寄存器进行压栈，做了一个push eip 的操作，而在ret的时候做了pop eip的操作。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">LDxy</span> </div> <div class="bd">在程序栈里面，除了我们跳转前的指令地址外，还需要保留CPU通用寄存器的中的数据<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Linuxer</span> </div> <div class="bd">0x0000000000400508 &lt;+0&gt;:     push   %rbp<br>0x0000000000400509 &lt;+1&gt;:     mov    %rsp,%rbp<br>0x000000000040050c &lt;+4&gt;:     sub    $0x18,%rsp<br>0x0000000000400510 &lt;+8&gt;:     movl   $0x1,-0x4(%rbp)<br>0x0000000000400517 &lt;+15&gt;:    movl   $0x2,-0x8(%rbp)<br>0x000000000040051e &lt;+22&gt;:    mov    -0x8(%rbp),%esi<br>0x0000000000400521 &lt;+25&gt;:    mov    -0x4(%rbp),%eax<br>0x0000000000400524 &lt;+28&gt;:    movl   $0x7,(%rsp)<br>=&gt; 0x000000000040052b &lt;+35&gt;:    mov    $0x6,%r9d<br> 0x0000000000400531 &lt;+41&gt;:    mov    $0x5,%r8d<br> 0x0000000000400537 &lt;+47&gt;:    mov    $0x4,%ecx<br> 0x000000000040053c &lt;+52&gt;:    mov    $0x3,%edx<br> 0x0000000000400541 &lt;+57&gt;:    mov    %eax,%edi<br> 0x0000000000400543 &lt;+59&gt;:    callq  0x4004cd &lt;add&gt;<br> 0x0000000000400548 &lt;+64&gt;:    mov    %eax,-0xc(%rbp)<br> 0x000000000040054b &lt;+67&gt;:    mov    $0x0,%eax<br> 0x0000000000400550 &lt;+72&gt;:    leaveq<br> 0x0000000000400551 &lt;+73&gt;:    retq<br>(gdb) i r<br>rcx            0x400560 4195680<br>rdx            0x7fffffffe4e8   140737488348392<br>rbp            0x7fffffffe3f0   0x7fffffffe3f0<br>rsp            0x7fffffffe3d8   0x7fffffffe3d8<br>r12            0x4003e0 4195296<br>r13            0x7fffffffe4d0   140737488348368<br>r14            0x0      0<br>r15            0x0      0<br>rip            0x40052b 0x40052b &lt;main+35&gt;<br>eflags         0x216    [ PF AF IF ]<br>cs             0x33     51<br>ss             0x2b     43<br>ds             0x0      0<br>es             0x0      0<br>fs             0x0      0<br>gs             0x0      0<br>(gdb) x&#47;24x $rbp<br>0x7fffffffe3f0: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00<br>0x7fffffffe3f8: 0xd5    0x03    0xa3    0xf7    0xff    0x7f    0x00    0x00<br>0x7fffffffe400: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00<br>(gdb) x&#47;24x ($rbp-24)<br>0x7fffffffe3d8: 0x07    0x00    0x00    0x00    0x00    0x00    0x00    0x00<br>0x7fffffffe3e0: 0xd0    0xe4    0xff    0xff    0xff    0x7f    0x00    0x00<br>0x7fffffffe3e8: 0x02    0x00    0x00    0x00    0x01    0x00    0x00    0x00<br>从gdb的结果来看，保存了局部变量 调用函数的参数，但是这里不理解的是我的main方法里面只定义了三个局部变量，为什么要分配24字节呢？ 加上传参的4字节应该16字节也够了<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/13/9d/d91dc762.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">喜欢吃鱼</span> </div> <div class="bd">徐老师，问您一个和这节内容不是很相关的一个问题可以吗？<br>为什么在写多重for循环的时候，循环次数多的大循环要写里面，小循环写外面？<br>希望老师解答下，非常感谢！！！<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Linuxer</span> </div> <div class="bd">问一个问题，我看老师objdump -M intel 这里-M的参数 intel是根据什么规则去选的呢？ 我看过man objdump还是不知道怎么指定<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/ec/2a/b11d5ad8.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">曾经瘦过</span> </div> <div class="bd">讲得很好很生动  基本都懂了 还需要反复阅读 加深印象  在读一读书   加深印象<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/41/87/cc6d5451.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Better me</span> </div> <div class="bd">push rbp；<br>mov rbp rsp；<br>老师，想问这两句是如何控制函数调用的<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/58/79/e7bbd28e.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">不系之舟</span> </div> <div class="bd">文章中的&quot;push rbp 就把之前调用函数的返回地址，压到栈顶。&quot;<br><br>感觉这句话有问题，函数的返回地址压到栈顶，应该是call指令做的。<br></div> <span class="time">2019-05-10</span>  </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/9b/ec/f16470a0.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">上五楼的快活</span> </div> <div class="bd">老师您好，刚订阅，在哪儿加学习小组<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">留言区就是大家的学习小组。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/13/9d/d91dc762.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">喜欢吃鱼</span> </div> <div class="bd">老师，为什么我把add函数变为inline函数之后，objdump出来的调用add处的汇编指令还是：call   25 &lt;main+0x25&gt;<br><br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">我推测是不是你在调用gcc的时候，没有开启 -O 参数来开启编译器优化？<br>gcc -g -c -O function_example_inline.c</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/41/87/cc6d5451.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">Better me</span> </div> <div class="bd">rbp、rsp是如何管理函数之间的调用的<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">Better me，抱歉，我没太理解，这是一个提问么？</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">免费的人</span> </div> <div class="bd">思考题：函数返回值、返回地址、sp bp<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">答案不太对哦，除了返回地址之外，这些都是不用在调用前单独压栈的，可以再搜索看看其他资料再来回答这个问题。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/4f/60/049a20e9.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">吴宇晨</span> </div> <div class="bd">我记得应该还要保存调用方的栈地址，调用结束才能还原栈，csapp之前看了，但是平常接触不到这些知识，都忘的差不多了😅😅<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">吴宇晨同学你好，调用方的栈地址是在他自己被调用的时候已经压栈了呀，可以再回头去看一下csapp。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/59/f6/ed66d1c1.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">chengzise</span> </div> <div class="bd">老师这里需要补冲一下，函数调用call指令时，（PC）指令地址寄存器会自动压栈，即返回地址压栈，函数返回ret指令时会自动弹栈，即返回地址赋值给PC寄存器，把之前。图片有显示压栈，没有文字说明，其他同学可以不太理解。<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">👍，谢谢 chengzise 同学，谢谢补充。call 在调用的时候会做push eip的操作，而在ret的时候会做pop eip的操作。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">拉欧</span> </div> <div class="bd">Push rbp, move rpb rsp,以前一直不知道这两句的含义，现在清楚了<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">👍</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/e9/57/68e414ba.jpg" class="avatar"> <div class="info"> <div class="hd"><span class="username">@我</span> </div> <div class="bd">还要保护现场，保护现场的变量值也是存到系统栈里面的？多线程切换的话，是不是也要存到自己线程对应的栈里面？<br></div> <span class="time">2019-05-10</span> <div class="reply"> <div class="reply-hd"><span>作者回复</span></div> <p class="reply-content">是存到寄存器或者栈里面的，如果寄存器里面存不下，就会放到栈帧里面去。<br><br>多线程情况下，每个线程有自己的栈。但是线程切换是context switch，这个和函数调用并不相同。context switch通常要解决的是把当前现场中的其他信息保留下来，比如寄存器里面的内容等等，而不是做一次压栈。</p> <p class="reply-time">2019-05-10</p> </div> </div> </li>  </ul> </div> </div> </div> </div> </div> </body> </html>
